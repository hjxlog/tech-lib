# 一、什么是docker

Docker是一个基于golang开发的开源**应用容器引擎**，让开发者可以打包他们的应用以及依赖包到一个可移植的镜像中，然后发布到任何流行的 Linux或Windows操作系统的机器上，也可以实现虚拟化。容器是完全使用沙箱机制，相互之间不会有任何接口。如下图，``env1``和``env2``为两个不同的docker容器，将两者隔离开来。



![image-20220307154813784](https://file.hjxlog.com/blog/images/image-20220307154813784.png)

**扩展知识：沙箱机制**

一个限制应用程序对系统资源的访问的运行环境，为程序提供一个**受限的运行环境**。如果没有隔离，一个应用程序是可以访问机器上的所有资源的，比如CPU、内存、文件系统、网络等等，这样不安全。

## 1.1 docker的特点

> 构建更安全

可以使用docker compose创建多容器的应用程序。docker可以和vscode，github等集成。将应用程序打包，以便在任何环境都可以始终如一地运行。

> 共享更广

docker hub提供一些官方镜像以及其他人发布上来的镜像。你也可以发布到docker hub中。可以通过角色管理控制访问权限。通过审计日志了解活动历史。

> 运行更快

轻松交付多个应用程序，并让它们在您的所有环境中以相同的方式运行，包括设计、测试、登台和生产 - 桌面或云原生环境。不用担心环境问题。以不同的语言独立地在不同的容器中部署您的应用程序。降低语言、库或框架之间发生冲突的风险。加快开发速度和启动速度。

## 1.2 docker可以用来干什么？

将软件打包成标准化单元以进行开发、交付和部署。把它作为一个交付单元，原来的话需要运维人员构建环境，我们提供jar/war包出去，让运维运行。现在docker打包代码以及其他依赖项。

Docker使开发高效且可预测，在开发的时候，一般有几个环境，开发、测试、生产，有时候会出现程序在这个环境可以，在另外的环境不行。也就是“明明在我的电脑上可以，怎么到了你那里就不行了？”的问题。docker环境可移植。

Docker 容器无处不在：Linux、Windows、数据中心、云、无服务器等。

## 1.3 docker历史

2013年推出。Docker 是 PaaS 提供商 dotCloud 开源的一个基于 LXC 的高级容器引擎，源代码托管在 Github 上, 基于go语言并遵从Apache2.0协议开源。

一款开源软件能否在商业上成功，很大程度上依赖三件事 - 成功的 user case(用例), 活跃的社区和一个好故事。

# 二、容器和虚拟机的不同

容器和虚拟机具有相似的资源隔离和分配优势，但功能不同，因为容器虚拟化的是操作系统而不是硬件。容器更便携、更高效。多个容器可以在同一台机器上运行并与其他容器共享操作系统内核，每个容器在用户空间中作为独立进程运行。容器是应用层的抽象，它将代码和依赖项打包在一起。

虚拟机 (VM) 是物理硬件的抽象，可将一台服务器变成多台服务器。每个 VM 都包含操作系统、应用程序、必要的二进制文件和库的完整副本——占用数十 GB。 VM 的启动速度也可能很慢。占用大，运行慢。

# 二、docker组成

> 一个完整的Docker有以下几个部分组成：

1. DockerClient客户端
2. Docker Daemon守护进程
3. Docker Image镜像
4. DockerContainer容器

> Docker引擎

Docker引擎(Docker Engine)是一个服务端-客户端结构的应用，主要有这些部分：Docker守护进程、Docker Engine API（页面存档备份，存于互联网档案馆）、Docker客户端。[6]

- Docker守护进程(Docker     daemons)，也叫 dockerd ，是一个持久化的进程，用户管理容器。守护进程会监听Docker Engine     API（页面存档备份，存于互联网档案馆） 的请求。[7]
- Docker     Engine API（页面存档备份，存于互联网档案馆）是用于与Docker守护进程交互用的的API。它是一个RESTful     API，因此它不仅可以被Docker客户端调用，也可以被wget 和 curl等命令调用。[8]
- Docker客户端，也叫docker，是大部分用户与Docker交互的主要方式。用户通过客户端将命令发送给守护进程。命令会遵循Docker     Engine API（页面存档备份，存于互联网档案馆）[9]

> Docker注册中心

Docker注册中心(Docker registry)是用于存储Docker的镜像。Docker Hub 是一个公共的注册中心，任何人都可以使用，默认配置下，Docker将会在这里寻找镜像。[6]

另外，用户可以自行构建私有注册中心。Docker Datacenter (DDC)的用户，可以直接使用 Docker Trusted Registry (DTR)。[6]

>对象

Docker的对象是指Images、Containers、Networks、Volumes、Plugins等等。[6]

容器（Containers）是镜像的可运行的实例。容器可通过API或CLI（命令行）进行操控。[6]

镜像（Images）是一个只读模板，用于指示创建容器。[6] 镜像分层(layers)构建的，而定义这些层次的文件叫Dockerfile。[10]

服务（Services）允许用户跨越不同的Docker守护进程（Docker daemons）的情况下增加容器，并将这些容器分为管理者（managers）和工作者（workers），让他们为swarm共同工作。[6]

## Docker Compose

Compose可译为组合物。[11]Compose 是用于定义和运行 多个容器Docker应用程序 的工具。通过Compose，你可以使用YAML文件来配置应用程序需要的所有服务，然后通过使用一个命令，就可以创建并启动所有服务。[12][13]Compose对应的命令为docker-compose。[14]

## Swarm Mode

当说到 Docker Swarm 时，一般是指单独项目 Docker Swarm。而在Docker 1.12时，将swarm mode集成到Docker 引擎中，可用Docker引擎API 和 CLI 命令直接使用。官方推荐用户使用集成的 swarm mode [15]。

Swarm Mode 内置 kv 存储功能，提供了众多的新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。使得 Docker 本地的 Swarm 集群具备与 Mesos、Kubernetes 竞争的实力。[16]

cluster(中文：集群)，Docker将集群定义为：一群共同作业并提供高可用性的机器[17] 。swarm(中文：群[18])，是指一个集群的Docker引擎以swarm mode形式运行[19]。swarm mode是指Docker引擎内嵌的集群管理和编排功能。当你初始化了一个swarm(cluster)或者将节点加入一个swarm时，其Docker引擎就会以swarm mode的形式运行。[20]

swarm mode的功能是由swarmkit(一个独立项目)提供的，它实现了Docker的编排层。swarm可以直接被Docker使用。[21]

## docker的故事：

因为用户需要的是高效运行环境而非OS。docker设想是交付运行环境如同海运，OS如同一个货轮，每一个在OS基础上的软件都如同一个集装箱，用户可以通过标准化手段自由组装运行环境，同时集装箱的内容可以由用户自定义，也可以由专业人员制造。这样，交付一个软件，就是一系列标准化组件的集合的交付，如同乐高积木，用户只需要选择合适的积木组合，并且在最顶端署上自己的名字(最后一个标准化组件是用户的app)。

Docker容器与虚拟机类似，但二者在原理上不同。容器是将操作系统层虚拟化，虚拟机则是虚拟化硬件，因此容器更具有便携性、高效地利用服务器。由于容器的标准化，因此它可以无视基础设施（Infrastructure）的差异，部署到任何一个地方。

# 文件格式

Docker有两种文件格式，Dockerfile和Compose file。Dockerfile定义了单个容器的内容和启动时候的行为。Compose file定义了一个多容器应用。[25]

Compose文件

Compose文件 是一个YAML文件，定义了服务（service）、网络、卷（volume）。

# 数据管理

Docker默认下，所有文件将会存储在容器里的可写的容器层（container layer）。[42]

- 数据与容器为一体。随着容器消失，数据将消失；难以与其他程序（容器）共享。
- 由于容器的写入层是与宿主机器紧紧耦合。所以你难以移动数据到其他机器。
- 容器的写入层的是通过 存储驱动（页面存档备份，存于互联网档案馆）（storage     driver） 管理文件系统。存储驱动（页面存档备份，存于互联网档案馆） 会使用Linux内核的 链合文件系统（union     filesystem）进行挂载。相比起直接操作于宿主机器文件系统的 数据卷，这额外的抽象层将会降低性能。

容器有两种永久化存储方式：卷（volumes）和 绑定挂载（bind mounts）。另外，Linux用户还可使用 tmpfs 进行挂载；Window用户还可以使用 命名管道（named pipe）。在容器中，不管是哪种永久化存储，表现形式都是一样的。[42]

# 卷

卷（volumes）是宿主机器的文件系统的一部分，由Docker进行管理（ 在Linux，存储于/var/lib/docker/volumes/）。非Docker程序不应该去修改这些文件。Docker推荐使用 卷 进行持久化数据。 卷 可支持 卷驱动（volume drivers），该驱动允许用户将数据存储到 远程主机 或 云服务商（cloud provider）或 其他。[42]

没有名字的卷叫匿名卷（anonymous volume），有名字的卷叫命名卷（named volume）。匿名卷没有明确的名字，当被初始化时，会被赋予一个随机名字。[42]