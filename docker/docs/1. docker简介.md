# 一、什么是docker

Docker是一个开源的应用容器引擎，基于 Go 语言开发，可以让开发者打包他们的应用和相关依赖环境等到容器中，然后发布到任何流行的Linux机器上，也可以实现虚拟化。docker是基于linux运行的，如果要在windows上运行，也需要安装相关的Linux虚拟机。

容器是完全使用沙箱机制，相互之间不会有任何接口，相互隔离，类似于我们手机APP，但是你依然可以使用网络等进行通信，更重要的是容器性能开销极低。如下图，``env1``和``env2``为两个不同的docker容器，将两者隔离开来。

<img src="https://file.hjxlog.com/blog/images/image-20220307154813784.png" style="zoom:70%;" />

**扩展知识：沙箱机制**

一个限制应用程序对系统资源的访问的运行环境，为程序提供一个**受限的运行环境**。如果没有隔离，一个应用程序是可以访问机器上的所有资源的，比如CPU、内存、文件系统、网络等等，这样不安全。

## 1.1 docker的特点

1. 构建更安全：因为可以打包应用程序和环境，可以保证在不同机器上的运行环境也是一样的。
2. 共享更广：可以把自己的镜像打包发给别人，或者docker hub上有很多共享镜像。
3. 运行更快：本身比较小，镜像也只有最基础的功能，运行自然就快。

## 1.2 docker的作用

将软件打包成标准化单元以进行开发、交付和部署。把它作为一个交付单元，原来的话我们开发好程序，提供jar/war包出去，需要运维人员搭建相关的环境再运行，现在docker打包代码以及其他依赖项，运维拿到docker镜像直接运行即可，方便快捷。

Docker使开发高效且可预测，在开发的时候，一般有几个环境，开发、测试、生产，有时候会出现程序在这个环境可以，在另外的环境不行。也就是“明明在我的电脑上可以，怎么到了你那里就不行了？”的问题。

## 1.3 docker历史

2013年推出。Docker 是 PaaS 提供商 dotCloud 开源的一个基于 LXC 的高级容器引擎，源代码托管在 Github 上, 基于go语言并遵从Apache2.0协议开源。

一款开源软件能否在商业上成功，很大程度上依赖三件事 - 成功的 user case(用例), 活跃的社区和一个好故事。

# 二、容器和虚拟机的区别

容器和虚拟机具有相似的资源隔离和分配优势，但功能不同，因为容器虚拟化的是操作系统而不是硬件。容器更便携、更高效。多个容器可以在同一台机器上运行并与其他容器共享操作系统内核，每个容器在用户空间中作为独立进程运行。容器是应用层的抽象，它将代码和依赖项打包在一起。

虚拟机 (VM) 是物理硬件的抽象，可将一台服务器变成多台服务器。每个 VM 都包含操作系统、应用程序、必要的二进制文件和库的完整副本——占用数十 GB。 VM 的启动速度也可能很慢。占用大，运行慢。

# 三、docker架构

## 3.1 架构图

使用客户端-服务器 (C/S) 架构模式：

![image-20220312105211150](C:\Users\hjx\AppData\Roaming\Typora\typora-user-images\image-20220312105211150.png)

## 3.2 基本概念

- **镜像（Image）**：用于创建 Docker 容器的模板，比如Ubuntu系统，里面包含了完整的一套Ubuntu最小系统的 root 文件系统。
- **容器（Container）**：镜像（Image）和容器（Container）的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。
- **仓库（Repository）**：仓库可看成一个代码控制中心，用来保存镜像。

## Docker Compose

Compose可译为组合物。[11]Compose 是用于定义和运行 多个容器Docker应用程序 的工具。通过Compose，你可以使用YAML文件来配置应用程序需要的所有服务，然后通过使用一个命令，就可以创建并启动所有服务。[12][13]Compose对应的命令为docker-compose。[14]

## Swarm Mode

当说到 Docker Swarm 时，一般是指单独项目 Docker Swarm。而在Docker 1.12时，将swarm mode集成到Docker 引擎中，可用Docker引擎API 和 CLI 命令直接使用。官方推荐用户使用集成的 swarm mode [15]。

Swarm Mode 内置 kv 存储功能，提供了众多的新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。使得 Docker 本地的 Swarm 集群具备与 Mesos、Kubernetes 竞争的实力。[16]

cluster(中文：集群)，Docker将集群定义为：一群共同作业并提供高可用性的机器[17] 。swarm(中文：群[18])，是指一个集群的Docker引擎以swarm mode形式运行[19]。swarm mode是指Docker引擎内嵌的集群管理和编排功能。当你初始化了一个swarm(cluster)或者将节点加入一个swarm时，其Docker引擎就会以swarm mode的形式运行。[20]

swarm mode的功能是由swarmkit(一个独立项目)提供的，它实现了Docker的编排层。swarm可以直接被Docker使用。[21]

## docker的故事：

因为用户需要的是高效运行环境而非OS。docker设想是交付运行环境如同海运，OS如同一个货轮，每一个在OS基础上的软件都如同一个集装箱，用户可以通过标准化手段自由组装运行环境，同时集装箱的内容可以由用户自定义，也可以由专业人员制造。这样，交付一个软件，就是一系列标准化组件的集合的交付，如同乐高积木，用户只需要选择合适的积木组合，并且在最顶端署上自己的名字(最后一个标准化组件是用户的app)。

Docker容器与虚拟机类似，但二者在原理上不同。容器是将操作系统层虚拟化，虚拟机则是虚拟化硬件，因此容器更具有便携性、高效地利用服务器。由于容器的标准化，因此它可以无视基础设施（Infrastructure）的差异，部署到任何一个地方。

# 文件格式

Docker有两种文件格式，Dockerfile和Compose file。Dockerfile定义了单个容器的内容和启动时候的行为。Compose file定义了一个多容器应用。[25]

Compose文件

Compose文件 是一个YAML文件，定义了服务（service）、网络、卷（volume）。

# 数据管理

Docker默认下，所有文件将会存储在容器里的可写的容器层（container layer）。[42]

- 数据与容器为一体。随着容器消失，数据将消失；难以与其他程序（容器）共享。
- 由于容器的写入层是与宿主机器紧紧耦合。所以你难以移动数据到其他机器。
- 容器的写入层的是通过 存储驱动（页面存档备份，存于互联网档案馆）（storage     driver） 管理文件系统。存储驱动（页面存档备份，存于互联网档案馆） 会使用Linux内核的 链合文件系统（union     filesystem）进行挂载。相比起直接操作于宿主机器文件系统的 数据卷，这额外的抽象层将会降低性能。

容器有两种永久化存储方式：卷（volumes）和 绑定挂载（bind mounts）。另外，Linux用户还可使用 tmpfs 进行挂载；Window用户还可以使用 命名管道（named pipe）。在容器中，不管是哪种永久化存储，表现形式都是一样的。[42]

# 卷

卷（volumes）是宿主机器的文件系统的一部分，由Docker进行管理（ 在Linux，存储于/var/lib/docker/volumes/）。非Docker程序不应该去修改这些文件。Docker推荐使用 卷 进行持久化数据。 卷 可支持 卷驱动（volume drivers），该驱动允许用户将数据存储到 远程主机 或 云服务商（cloud provider）或 其他。[42]

没有名字的卷叫匿名卷（anonymous volume），有名字的卷叫命名卷（named volume）。匿名卷没有明确的名字，当被初始化时，会被赋予一个随机名字。[42]



# 其他相关知识

podman：什么是 Podman？Podman 是一个无守护进程的容器引擎，用于在 Linux 系统上开发、管理和运行 OCI 容器。

多亏了 OCI，您在选择容器工具链时可以选择，包括 Docker、[CRI-O](https://cri-o.io/)、[Podman](http://podman.io/)、[LXC](https://linuxcontainers.org/)等。

根据设计，容器可以快速增加，无论您是运行大量不同的服务还是运行少数服务的多个实例。如果您决定在容器中运行服务，您可能需要设计用于托管和管理这些容器的软件。这被广泛称为[容器编排](https://opensource.com/article/20/11/orchestration-vs-automation)。虽然 Docker 和其他容器引擎（如 Podman 和 CRI-O）是用于容器定义和映像的良好实用程序，但创建和运行容器是它们的工作，而不是帮助您组织和管理它们。[Kubernetes](https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/)和[OKD](http://okd.io/)等项目为 Docker、Podman、CRI-O 等提供容器编排。